<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>D3!</title>
<style>

  html { height: 100% }
			body { height: 100%; margin: 0; padding: 0;}
			#map{ height: 100% }

.bike {
  stroke: #fff;
  stroke-width: 4px;
  fill:none;
}
.bike.b1 {
	 stroke: #E41A1C;
}
.bike.b2 {
	 stroke: #377EB8;
}
.bike.b3 {
	 stroke: #4DAF4A;
}
.bike.b4 {
	 stroke: #984EA3;
}
.bike.b5 {
	 stroke: #FF7F00;
}
.bike.b6 {
	 stroke: #FFFF33;
}
.bike.b7 {
	 stroke: #A65628;
}
.bike.b8 {
	 stroke: #F781BF;
}
.bike.b9 {
	 stroke: #999999;
}
.bike:hover {
  stroke: brown;
  cursor:pointer;
}
.town { 
	stroke-width : 0;
	fill: #000;
	fill-opacity: .6;
	stroke: #fff; 
}

.town:hover {
  fill: brown;
  fill-opacity: .7;
  cursor:pointer;
}
.bar {
  fill: steelblue;
  fill-opacity: .9;
}
</style><link rel="stylesheet" href="leaflet/leaflet.css" />
<link rel="stylesheet" href="css/colorbrewer.css" />
<!--[if lte IE 8]>
	<link rel="stylesheet" href="leaflet/leaflet.ie.css" />
<![endif]-->

<script src="leaflet/leaflet-src.js"></script>
<link rel="stylesheet" href="css/gh-fork-ribbon.css" />
    <!--[if IE]>
        <link rel="stylesheet" href="css/gh-fork-ribbon.ie.css" />
    <![endif]-->
    </head>
    <body>
        <div class="github-fork-ribbon-wrapper left">
            <div class="github-fork-ribbon"><!--from http://simonwhitaker.github.com/github-fork-ribbon-css/ -->
                <a href="https://github.com/calvinmetcalf/leaflet.d3">Fork me on GitHub</a>
            </div>
        </div>
<div id="map"></div>

<script src="js/d3.v3.js"></script>
<script src="js/topojson.v0.js"></script>
<script src="leaflet.d3.js"></script>
<script>
var m = L.map("map").setView([42.08, -71.64],8);

var stamenAttribution = 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; ' +
		  'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>';
		  
var tiles = L.layerGroup(
	[
		L.tileLayer(
			"http://{s}.tile.stamen.com/terrain-background/{z}/{x}/{y}.jpg",
			{
				minZoom:4,
				maxZoom:18
			}
		),
		L.tileLayer(
			"http://{s}.tile.stamen.com/terrain-lines/{z}/{x}/{y}.png",
			{
				minZoom:4,
				maxZoom:12,
				attribution:stamenAttribution
			}
		)
	]
).addTo(m);
var quintile=d3.scale.quantile()//ugly I know
.domain([57.63315217391305,26.40730337078652,583.9344262295082,86.78195488721805,880.3125,55.03157894736842,87.21400778210116,391.86538461538464,29.274285714285714,132.3175182481752,66.91609353507566,41.62700964630225,28.490909090909092,161.75193798449612,65.28191489361703,528.5781990521327,22.079778393351802,42.903047091412745,141.41952506596306,64.56565656565657,51.311688311688314,41.90769230769231,84.10810810810811,459.89830508474574,24.082004555808656,54.31858407079646,144.5181518151815,21.090683229813664,2.775631500742942,3.336734693877551,0.44905008635578586,6.521546961325967,51.38461538461539,36.4365671641791,210.1985294117647,40.8021978021978,6.254205607476636,16.504939626783756,34.84065934065934,2.849686847599165,38.533910533910536,31.32080200501253,22.3206106870229,223.87906976744185,4.225903614457831,57.37966101694915,37.202003338898166,2.443452380952381,131.86567164179104,85.8232044198895,1.1719532554257095,23.35456475583864,2.2293333333333334,7.497737556561086,13.517021276595745,379.36150234741785,38.556650246305416,1.2326103216155573,37.21996303142329,182.36363636363637,1.5309446254071661,79.56792873051225,20.388349514563107,30.936893203883496,113.74774774774775,1.3947990543735225,5.121642969984202,85.19627906976744,2.169429097605893,49.56774193548387,39.92355212355212,14.370572207084468,7.2970620239390644,26.494208494208493,411.3317757009346,186.6771653543307,17.167932489451477,572.6909090909091,6.641821946169772,243.8031496062992,44.72,10.329199549041714,76.84180790960453,108.13944223107569,16.81508078994614,78.61931818181819,65.78433598183882,59.75692963752665,56.333333333333336,56.88559322033898,55.08860759493671,5.498763396537511,6.871452420701169,14.943134535367545,44.2367758186398,66.85048543689321,22.032418952618453,26.390519187358915,364.2682634730539,17.78676470588235,7.715254237288136,269.3212121212121,345.3411078717201,13.303621169916434,1.5495867768595042,1.1204943357363544,610.8518518518518,64.5320197044335,88.72972972972973,203.86206896551724,10.492366412213741,7.614197530864198,67.65789473684211,129.28095238095239,25.885964912280702,15.977573904179408,55.0359477124183,20.983333333333334,19.48051948051948,369.53846153846155,55.307826086956524,91.91461412151067,16.56272838002436,105.8605504587156,45.515151515151516,1.0327272727272727,37.907407407407405,21.9,7.575317604355717,48.92273730684327,1.5053763440860215,20.22222222222222,29.749333333333333,240.81553398058253,8.685,88.80933852140078,19.452905811623246,43.49732620320856,5.246376811594203,180.53465346534654,1549.56,73.48717948717949,125.38876404494383,5.974683544303797,67.29135180520571,50.496350364963504,4.1120448179271705,14.419624217118997,51.64414414414414,22.074708171206225,102.29710144927536,248.7926267281106,6.132553606237817,155.10614525139664,47.94661921708185,7.513931888544891,14.134228187919463,98.23908045977012,17.57038391224863,261.76100628930817,1.9466073414905452,620.4406779661017,224.44578313253012,355.24279835390945,3.124231242312423,37.7602862254025,81.73640856672158,2.342042755344418,39.46666666666667,42.26553672316384,33.933503836317136,14.687258687258687,22.010610079575596,71.35977337110482,18.316384180790962,63.4120082815735,393.3983739837398,27.441527446300714,14.041297935103245,7.243697478991597,207.61458333333334,923.8541176470588,36.07129094412331,36.46441947565543,115.15805022156573,59.68813559322034,1.750540735400144,16.536779324055665,25.226114649681527,16.631364562118126,179.45888594164455,31.396578538102645,22.60262891809909,113.65758754863813,80.04330708661418,43.146496815286625,30.963093145869948,93.5016611295681,2.668896321070234,92.41573033707866,97.14206128133705,75.84223300970874,4.9855072463768115,609.9136690647482,10.444444444444445,9.074960127591707,3.495145631067961,93.76357827476038,26.18539976825029,117.3444909344491,75.00471698113208,72.2439024390244,61.23529411764706,61.23047375160051,8.800344234079175,2.91044776119403,71.44680851063829,7.640732265446224,348.62846580406654,14.32394366197183,658.5172413793103,7.747081712062257,149.51633986928104,1132.4581005586592,84.10931174089069,23.883544303797468,3.8579545454545454,20.38552036199095,30.389908256880734,13.375886524822695,46.71475409836066,58.705882352941174,16.642857142857142,85.45454545454545,30.54901960784314,93.53216374269006,60.76021798365122,11.399698340874812,5.6991525423728815,7.865951742627346,18.049723756906076,874.4137931034483,106.66006600660066,188.20470829068577,58.53046594982079,110.92765957446808,2.096124031007752,62.48461538461538,192.54676258992805,117.35875216637781,1132.774193548387,9.815295815295816,2.788912579957356,3.083440308087291,180.97019867549668,3.3518886679920477,9.634285714285713,146.71038251366122,58.556451612903224,3.326605504587156,50.42433234421365,3.7222222222222223,3.3096446700507616,24.70250896057348,142.8441926345609,40.50990752972259,65.19591836734693,23.08411214953271,14.692387904066736,29.329815303430077,171.89743589743588,11.059371362048894,105.39483394833948,35.84285714285714,7.062176165803109,86.24786324786325,3.995661605206074,0.5391849529780565,50.65986394557823,17.903649635036498,2.798528058877645,13.033766233766233,65.70705244122966,22.33216374269006,49.08943089430894,15.48626817447496,57.38461538461539,139.2937062937063,84.38571428571429,37.86099290780142,7.38243626062323,112.85358255451713,302.73972602739724,6.403534609720177,30.0625,50.34188034188034,21.776053215077606,33.769751693002256,44.346666666666664,20.31827111984283,1.5828759604829856,65.98496240601504,49.30051813471503,5.056894889103182,17.088571428571427,43.92198581560284,14.73469387755102,129.45993413830956,0.875,2.488408037094281,68.67702936096718,6.770343580470163,122.55681818181819,33.811688311688314,14.812307692307693,87.84546805349183,19.54325259515571,68.54785478547855,44.70909090909091,1.7626016260162602,151.52325581395348,0.7126436781609196,15.007181328545782,220.12121212121212,15.90643274853801,158.0835380835381,180.21183800623052,1.4195402298850575,371.35841584158413,3.5722543352601157,2.487926727726894,1.2419786096256684,21.563402889245587,152.1150442477876,370.92477876106193,53.23155216284987,55.8212927756654,20.70126227208976,7.858081471747701,731.4010152284264,17.00284090909091,33.5072,18.49544626593807,110.88053691275168,5.589915966386554,140.8584686774942,3.3785557986870898,42.17801047120419,37.0316742081448,124.56573705179282,563.8981233243968])
.range(d3.range(10));

var topo=L.d3("json/ma.topo.json",{topojson:"TOWNS",pathClass:function(d) {return "town q" + quintile(d.properties.pop/topo._path.area(d))+"-10";}}).addTo(m);
/*var nontopo=L.d3("json/bikes.json",{pathClass:function(d){
	var stat;
	var facT =d.properties.FacilityType;
	var pn = facT.indexOf("(");
	if( pn>0 ){
				facT = facT.slice(0,pn);
		}
		switch (facT.trim()) {
			case 'Bike lane':
				stat=1;
				break;
			case "Bicycle/Pedestrian priority roadway":
				stat=2;
				break;
			case "Cycle track":
					stat=3;
				break;
			case "Marked shared lane":
					stat=4;
				break;
			case "Shared use path":
					stat=5;
				break;
			case "Sign-posted on-road bike route":
				stat=6;
				break;
			case "On-Road - To Be Determined":
					stat=7;
				break;
			case "Paved bike shoulder":
				stat=8;
				break;
			case "Hybrid":
					stat=9;
				break;
		}

	return "bike b" + stat;
}});
nontopo.bindPopup(function(p){
	var out =[];
	for(var key in p){
		if(p[key] && p[key] !== "" && ["Shape_Length","OBJECTID"].indexOf(key) === -1){
			out.push("<strong>"+key+"</strong>: "+p[key]);
		}
	}
	return "<ul><li>"+out.join("</li><li>")+"</li></ul>";
});*/
topo.bindPopup(function(p){
	var out =[];
	for(var key in p){
		out.push("<strong>"+key+"</strong>: "+p[key]);
	}
	return out.join("<br/>");
	});
var stamenWaterColor = L.tileLayer(
	'http://{s}.tile.stamen.com/watercolor/{z}/{x}/{y}.jpg',
	{
		minZoom: 3,
		maxZoom: 16,
		attribution:stamenAttribution
	}
);

 L.control.layers({"Stamen Terrain":tiles,"Stamen Watercolors":stamenWaterColor},{"Towns (topojson)":topo/*,"Bike Paths (geojson)":nontopo*/},{collapsed:false}).addTo(m);   
	

</script>
 <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-31218444-1']);
            _gaq.push(['_trackPageview']);
            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
</body>
</html>